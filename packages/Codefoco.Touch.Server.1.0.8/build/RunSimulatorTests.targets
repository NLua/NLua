<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <TouchServerExe Condition=" '$(TouchServerExe)' == '' ">$(MSBuildProjectDirectory)/tools/Touch.Server.exe</TouchServerExe>
        <MLaunch Condition=" '$(MLaunch)' == '' ">/Developer/MonoTouch/usr/bin/mlaunch</MLaunch>
        <TargetFrameworkIdentifier Condition=" '$(TargetFrameworkIdentifier)' == ''">Xamarin.iOS</TargetFrameworkIdentifier>
        <DeviceKind Condition=" '$(TargetFrameworkIdentifier)' == 'Xamarin.iOS'">iPhone</DeviceKind>
        <DeviceKind Condition=" '$(TargetFrameworkIdentifier)' == 'Xamarin.TVOS'">Apple TV</DeviceKind>
        <DevicesXmlFile>$(OutputPath)/DevicesXmlFile.xml</DevicesXmlFile>
        <TestResult Condition=" '$(TestResult)' == '' ">TEST-Result-$(TargetFrameworkIdentifier).xml</TestResult>
    </PropertyGroup>
    <Target Name="FetchDeviceSpecs"  Condition="'$(OS)'=='Unix' and Exists('/usr/lib/libc.dylib')" DependsOnTargets="_DetectSdkLocations;GetAppBundleDir" >
        <Message Text="Reading available devices" />
        <Exec Command="$(MLaunch) --listsim=$(DevicesXmlFile)" Condition="!Exists('$(DevicesXmlFile)')" />
        <XmlPeek 
                XmlInputPath="$(DevicesXmlFile)" 
                Query="//MTouch/Simulator/AvailableDevices/SimDevice[contains(@Name,&quot;$(DeviceKind)&quot;)][last()]/SimRuntime/text()">
        <Output TaskParameter="Result" ItemName="SimRuntime" />
        </XmlPeek>
        <XmlPeek 
                XmlInputPath="$(DevicesXmlFile)" 
                Query="//MTouch/Simulator/AvailableDevices/SimDevice[contains(@Name,&quot;$(DeviceKind)&quot;)][last()]/SimDeviceType/text()">
        <Output TaskParameter="Result" ItemName="SimDeviceType" />
        </XmlPeek>
    </Target>
    <Target Name="RunSimulatorTests"  Condition="'$(OS)'=='Unix' and Exists('/usr/lib/libc.dylib')" DependsOnTargets="FetchDeviceSpecs" >
        <Message Text="Running Simulator tests [@(SimRuntime):@(SimDeviceType)]" />
        <Exec Command="mono $(TouchServerExe) --launchsim &quot;$(AppBundleDir)&quot; --logfile=$(TestResult)  -autoexit -skipheader --verbose --mtouch-argument=&quot;--sdkroot=$(_SdkDevPath) --sdk=$(MtouchSdkVersion)&quot; --device=&quot;:v2:runtime=@(SimRuntime),devicetype=@(SimDeviceType)&quot;" />
    </Target>
</Project>